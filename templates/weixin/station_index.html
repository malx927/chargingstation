{% extends 'weixin/wx_base.html' %}{% load static %}
{% block js %}
{% include 'wxchat/include/jssdk.html' %}
  <script type="text/javascript" src="{% static 'weixin/js/jquery-3.3.1.min.js' %}"></script>
{% endblock js %}
{% block title %}附近充电站{% endblock %}
{% block content %}
    <div class="page">
         <div>
             <form action="#">
                 <div class="van-search van-search--show-action" style="background: rgb(255, 255, 255);">
                     <div class="van-search__content van-search__content--square">
                         <div class="van-cell van-cell--borderless van-field">
                             <div class="van-field__left-icon"><i class="van-icon van-icon-search"><!----></i></div>
                             <div class="van-cell__value van-cell__value--alone">
                                 <div class="van-field__body"><input type="search" finished-text="没有更多了" placeholder="请输入充电站名称或地点" class="van-field__control"></div>
                             </div>
                         </div>
                     </div>
                     <div class="van-search__action"><div>搜索</div></div>
                 </div>
             </form>
              <div class="physicalstore_list van-list" id="stations">
                  {% for station in stations %}
                  <div class="store">
                      <div class="store__header">{{ station.name }}<p>0km</p></div>
                      <div class="store__info">
                          <div class="store__thumb">
                          {% if station.stationimage_set.count > 0 %}
                              <img src="{{ station.stationimage_set.first.image.url }}" alt="">
                          {% endif %}
                          </div>
                          <a href="{% url 'station-detail' station.id %}" class="store__detail">
                              <h3 class="store__detail__address">{{ station.address }}</h3>
                              <p class="store__detail__time">空闲充电枪 {{ station.get_gun_totals }}</p><!---->
                          </a>
                          <a href="javascript:void(0)" class="store__phone" data-longitude="{{ station.longitude }}"  data-latitude="{{ station.latitude }}"  data-name="{{ station.name }}" data-address="{{ station.address }}"><i class="van-icon van-icon-map-marked"><!----></i></a>
                      </div>
                  </div>
                  {% endfor %}
                  <div class="van-list__finished-text">没有更多了</div>
              </div>
         </div>
     </div>
{% endblock content %}
{% block bottomjs %}
<script>
 wx.ready(function () {
    wx.getLocation({
        type: 'wgs84',
        success : function(res) {
            var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
            var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
            geocoder(latitude, longitude);
        },
        cancel : function(res) {
            var city = "北京"
            station_list(city);
        }
    });
    $(".store__phone").on('click',function(){
        var longitude = $(this).attr("data-longitude");
        var latitude = $(this).attr("data-latitude");
        var name = $(this).attr("data-name");
        var address = $(this).attr("data-address");
        console.log(longitude, latitude, name , address);
         wx.openLocation({
            latitude: latitude,
            longitude: longitude,
              name: name,
              address: address,
              scale: 13,
              infoUrl: ''
        });
    });
});

function geocoder(latitude,longitude) {
    var ll=latitude+","+longitude;
    $.ajax({
        type: 'get',
        url: 'https://apis.map.qq.com/ws/geocoder/v1/',
        dataType: 'jsonp',
        data : {
            key:"TOLBZ-NWYLP-A5SD6-VKAJC-UZLHQ-XKB7X",  //开发密钥
            location:ll,
            get_poi:"1",//是否返回周边POI列表：1.返回；0不返回(默认)
            output:"jsonp"
        },
        success: function(data, textStatus){
            if(data.status == 0){
                var city = data.result.address_component.city;
                alert(city)
                station_list(city);
            }else {
                alert("系统错误，请联系客服！")
            }
        },
        error: function(err){
            alert("系统错误，请联系客服！");
        }
    });
 }
 
 function station_list(city) {

     $.ajax({
          type: 'GET',
          url: "{% url 'station-list' %}",
          dataType: 'json',
          data: {city: city},
          timeout: 5000,
          success: function(data){
              alert(JSON.stringify(data));
          },
          error: function(xhr, type,error){}
     });
 }
 
</script>
{% endblock bottomjs %}